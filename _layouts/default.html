<!DOCTYPE html>
<html lang="{{ page.lang | default: site.lang | default: "en" }}">

  {%- include head.html -%}

<script>

document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll("img").forEach(img => {
    img.onerror = () => img.remove();
  });
});
</script>

<!--search-->

<script src="https://unpkg.com/simple-jekyll-search@1.9.2/dest/simple-jekyll-search.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const input = document.getElementById('search-input')
  const results = document.getElementById('results-container')

  if (!input || !results) return

  fetch('/search.json')
    .then(r => r.json())
    .then(data => {
      SimpleJekyllSearch({
        searchInput: input,
        resultsContainer: results,
        json: data,
        searchResultTemplate: `
          <li>
            <a href="{url}" class="search-result"
               data-title="{title}"
               data-content="{content}">
              <strong class="title">{title}</strong>
              <div class="search-snippet"></div>
            </a>
          </li>
        `,
        noResultsText: '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ',
        limit: 10,
        fuzzy: false
      })

      input.addEventListener('input', function () {
        const query = input.value

        setTimeout(() => {
          document.querySelectorAll('.search-result').forEach(link => {
            const title = link.dataset.title
            const content = link.dataset.content
            const snippet = link.querySelector('.search-snippet')

            link.querySelector('.title').innerHTML =
              highlight(title, query)

            snippet.innerHTML =
              makeSnippet(content, query)
          })
        }, 0)
      })
    })
})
</script>

<script>
document.addEventListener('keydown', function (e) {
  const active = document.activeElement
  const isInput =
    active.tagName === 'INPUT' ||
    active.tagName === 'TEXTAREA' ||
    active.isContentEditable

  if (isInput) return

  if (e.key === '/') {
    e.preventDefault()
    window.location.href = '/search/'
  }
})
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const input = document.getElementById('search-input')
  if (input) input.focus()
})
</script>

<script>
function highlight(text, query) {
  if (!query) return text

  const normalizedQuery = query
    .toLowerCase()
    .replace(/—ë/g, '–µ')
    .trim()

  if (!normalizedQuery) return text

  const words = normalizedQuery.split(/\s+/)

  let result = text

  words.forEach(word => {
    if (word.length < 2) return

    const regex = new RegExp(`(${word})`, 'gi')
    result = result.replace(regex, '<span class="search-highlight">$1</span>')
  })

  return result
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const params = new URLSearchParams(window.location.search)
  const query = params.get('q')

  if (!query) return

  const words = query
    .toLowerCase()
    .replace(/—ë/g, '–µ')
    .split(/\s+/)
    .filter(w => w.length > 1)

  if (!words.length) return

  const article = document.querySelector('article')
  if (!article) return

  function walk(node) {
    if (node.nodeType === 3) {
      let text = node.nodeValue
      let replaced = false

      words.forEach(word => {
        const regex = new RegExp(`(${word})`, 'gi')
        if (regex.test(text)) {
          text = text.replace(
            regex,
            '<span class="article-highlight">$1</span>'
          )
          replaced = true
        }
      })

      if (replaced) {
        const span = document.createElement('span')
        span.innerHTML = text
        node.replaceWith(span)
      }
    } else if (
      node.nodeType === 1 &&
      !['SCRIPT', 'STYLE', 'NOSCRIPT'].includes(node.tagName)
    ) {
      Array.from(node.childNodes).forEach(walk)
    }
  }

  walk(article)

  // –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–µ—Ä–≤–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é
  const first = article.querySelector('.article-highlight')
  if (first) {
    first.classList.add('current')
    first.scrollIntoView({ behavior: 'smooth', block: 'center' })
  }
})
</script>

<script>
function normalize(text) {
  return text.toLowerCase().replace(/—ë/g, '–µ')
}

function highlight(text, query) {
  if (!query) return text

  const words = normalize(query).split(/\s+/).filter(w => w.length > 1)
  let result = text

  words.forEach(word => {
    const regex = new RegExp(`(${word})`, 'gi')
    result = result.replace(regex, '<span class="search-highlight">$1</span>')
  })

  return result
}

function makeSnippet(content, query, radius = 80) {
  const normContent = normalize(content)
  const words = normalize(query).split(/\s+/).filter(w => w.length > 1)

  let index = -1
  for (const word of words) {
    index = normContent.indexOf(word)
    if (index !== -1) break
  }

  if (index === -1) {
    return content.slice(0, radius * 2) + '‚Ä¶'
  }

  const start = Math.max(0, index - radius)
  const end = Math.min(content.length, index + radius)

  let snippet = content.slice(start, end)

  if (start > 0) snippet = '‚Ä¶' + snippet
  if (end < content.length) snippet += '‚Ä¶'

  return highlight(snippet, query)
}

document.addEventListener('DOMContentLoaded', function () {
  const input = document.getElementById('search-input')
  const results = document.getElementById('results-container')

  if (!input || !results) return

  fetch('/search.json')
    .then(r => r.json())
    .then(data => {
      SimpleJekyllSearch({
        searchInput: input,
        resultsContainer: results,
        json: data,
        searchResultTemplate: `
          <li>
            <a href="{url}" class="search-result"
               data-title="{title}"
               data-content="{content}">
              <strong class="title">{title}</strong>
              <div class="search-snippet"></div>
            </a>
          </li>
        `,
        noResultsText: '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ',
        limit: 10,
        fuzzy: false
      })

      input.addEventListener('input', function () {
        const query = input.value.trim()

        setTimeout(() => {
          document.querySelectorAll('.search-result').forEach(link => {
            const title = link.dataset.title
            const content = link.dataset.content

            // üîπ –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞
            link.querySelector('.title').innerHTML =
              highlight(title, query)

            // üîπ —Å–Ω–∏–ø–ø–µ—Ç —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π
            link.querySelector('.search-snippet').innerHTML =
              makeSnippet(content, query)

            // üîπ –í–ê–ñ–ù–û: –ø–µ—Ä–µ–¥–∞—ë–º –∑–∞–ø—Ä–æ—Å –≤ —Å—Ç–∞—Ç—å—é
            const baseUrl = link.getAttribute('href').split('?')[0]
            link.setAttribute(
              'href',
              `${baseUrl}?q=${encodeURIComponent(query)}`
            )
          })
        }, 0)
      })
    })
})
</script>

<!--endsearch-->

  <body>

    {%- include header.html -%}

    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        {{ content }}
      </div>
    </main>

    {%- include footer.html -%}

  </body>


</html>
