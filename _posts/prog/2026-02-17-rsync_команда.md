---
layout: post
title: rsync. Подробное руководство.
categories: Программы
---

### Команда `rsync`: подробное руководство

`rsync` — мощная утилита для синхронизации файлов и каталогов между локальными и удалёнными системами. Отличается эффективностью за счёт передачи только изменённых частей файлов, поддерживает сжатие, сохранение атрибутов и гибкую настройку фильтров.

### Основные преимущества

- **Экономия трафика**: передаёт только изменения в файлах, а не целые файлы.
- **Сохранение атрибутов**: права доступа, владельцы, временные метки, символические ссылки.
- **Возобновление передачи**: при обрыве соединения можно продолжить с места остановки.
- **Гибкость**: локальная, удалённая (через SSH) и демон‑режим синхронизации.
- **Инкрементное копирование**: автоматически определяет изменённые файлы.

### Базовый синтаксис

```bash
rsync [опции] источник назначение
```

### Ключевые опции

- `-a` (`--archive`) — режим архива: рекурсивное копирование с сохранением атрибутов (права, владельцы, время).
- `-v` (`--verbose`) — подробный вывод информации.
- `-r` (`--recursive`) — рекурсивное копирование подкаталогов.
- `-z` (`--compress`) — сжатие данных при передаче.
- `-h` (`--human-readable`) — читаемый формат размеров файлов.
- `--progress` — отображение прогресса копирования.
- `-u` (`--update`) — пропускать файлы, которые новее в месте назначения.
- `--delete` — удалять файлы в назначении, если их нет в источнике.
- `--exclude=ШАБЛОН` — исключить файлы/каталоги по шаблону.
- `--include=ШАБЛОН` — включить файлы/каталоги по шаблону.
- `-n` (`--dry-run`) — тестовый прогон без реальных изменений.
- `-e SSH_COMMAND` — указание команды для удалённого подключения (например, `ssh -p 2222`).
- `--bwlimit=КБИТ/С` — ограничение скорости передачи.
- `--partial` — сохранение частично переданных файлов.
- `--inplace` — обновление файлов без временных копий.


### Примеры использования

#### 1. Локальное копирование с сохранением структуры

```bash
rsync -av /home/user/docs/ /backup/docs/
```
- `-a`: сохраняет права, владельцев, время.
- `-v`: выводит список копируемых файлов.

#### 2. Удаленная синхронизация через SSH

```bash
rsync -avz -e ssh /local/folder/ user@server:/remote/folder/
```
- `-z`: сжатие данных.
- `-e ssh`: использование SSH для передачи.

#### 3. Копирование только новых файлов

Чтобы копировались **только новые файлы** (отсутствующие в месте назначения):

```bash
rsync -av --ignore-existing /source/ /destination/
```
- `--ignore-existing`: пропускает файлы, уже существующие в назначении.

#### 4. Копирование новых и изменённых файлов

Чтобы копировались **новые и изменённые файлы** (по дате изменения):

```bash
rsync -avu /source/ /destination/
```
- `-u` (`--update`): копирует только файлы, которые новее в источнике.

**Как работает**:

- Если файл в источнике новее (по времени модификации), он копируется.
- Если файл в источнике старее, он пропускается.
- Если файла нет в назначении, он копируется (новый файл).

#### 4-1. Копирование с проверкой контрольных сумм (точная синхронизация)

`rsync -avuc /source/ /destination/`

- `-c:` - сравнивает файлы по контрольным суммам (гарантирует, что даже при одинаковом времени модификации изменённый файл будет скопирован).

**Когда использовать**:

Если время модификации файлов могло быть изменено (например, при восстановлении из бэкапа).


#### 5. Тестовый прогон (проверка без копирования)

```bash
rsync -avn /source/ /destination/
```
- `-n` (`--dry-run`): показывает, какие файлы будут скопированы, без реальных действий.

#### 6. Исключение временных файлов

```bash
rsync -av --exclude='*.tmp' --exclude='cache/' /source/ /destination/
```
- `--exclude`: исключает файлы по шаблону (например, `.tmp` и каталог `cache/`).

#### 7. Синхронизация с удалением устаревших файлов

```bash
rsync -av --delete /source/ /destination/
```
- `--delete`: удаляет файлы в назначении, если их нет в источнике.

#### 8. Ограничение скорости передачи

```bash
rsync -av --bwlimit=5000 /source/ /destination/
```
- `--bwlimit=5000`: ограничивает скорость до 5000 КБ/с.

#### 9. Возобновление прерванной передачи

```bash
rsync -av --partial --inplace /source/ /destination/
```
- `--partial`: сохраняет частично переданные файлы.
- `--inplace`: обновляет файлы напрямую (без временных копий).


### Как настроить копирование только новых файлов

Для копирования **исключительно новых файлов** (которые отсутствуют в месте назначения) используйте опцию `--ignore-existing`:

```bash
rsync -av --ignore-existing /путь/к/источнику/ /путь/к/назначению/
```

**Пояснение:**

- `-a`: включает архивный режим (рекурсия, права, время).
- `-v`: подробный вывод.
- `--ignore-existing`: игнорирует файлы, уже присутствующие в назначении, даже если они старше.


**Пример:** 

Если в `/source/` появился новый файл `report.txt`, а в `/destination/` его нет, он будет скопирован. Если `report.txt` уже есть в `/destination/`, он не будет перезаписан.

### Дополнительные сценарии

#### Инкрементное резервное копирование

Сохраняет старые версии изменённых файлов в отдельной директории:

```bash
rsync -av --backup --backup-dir=/backup/old/ /source/ /destination/
```

#### Синхронизация с указанием порта SSH

```bash
rsync -av -e "ssh -p 2222" /local/folder/ user@server:/remote/folder/
```

#### Копирование по списку файлов

```bash
rsync -av --files-from=list.txt /source/ /destination/
```
Где `list.txt` содержит пути к нужным файлам.

### Советы по безопасности

- Для удалённой синхронизации используйте **SSH** (опция `-e ssh`).
- Настройте **ключи SSH** для беспарольного доступа:

  ```bash
  ssh-keygen -t rsa -b 4096
  ssh-copy-id user@remote_host
  ```
- Для демон‑режима (порт `873`) используйте **SSH‑туннель** или фаервол.

### Автоматизация через cron

Чтобы запускать синхронизацию ежедневно в 22:00, добавьте в `crontab`:

```bash
0 22 * * * rsync -av --ignore-existing /source/ /destination/
```

### Важные замечания

- **Завершающие слеши**:

- `/source/` (со слешем) — копирует содержимое каталога.
- `/source` (без слеша) — копирует сам каталог внутрь назначения.
- **Права доступа**: для сохранения владельцев и групп может потребоваться `sudo`.
- **Сетевые задержки**: при медленных соединениях используйте `--bwlimit` и `--compress`.

### Заключение

`rsync` — универсальный инструмент для:

- резервного копирования;
- миграции данных;
- синхронизации между серверами;
- локального управления файлами.

Для сложных сценариев изучайте `man rsync` или официальную документацию.
