---
layout: post
title: rsync. Копирование файлов, которых отсутствуют в папке назначения и измененные файлы.
categories: Программы
---


Для копирования **отсутствующих** в папке назначения файлов **и обновлённых** (изменённых) файлов с помощью `rsync` используйте комбинацию опций, ориентируясь на временные метки файлов.


#### Основной вариант: сравнение по времени модификации (`--update` или `-u`)


```bash
rsync -avu /источник/ /назначение/
```

Как работает:

- `-a` (archive) — сохраняет права, временные метки, ссылки и др.;
- `-v` (verbose) — подробный вывод;
- `-u` (`--update`) — копирует файл **только если в источнике он новее**, чем в назначении (по времени модификации).


Что копируется:

1. Файлы, отсутствующие в назначении → копируются.
2. Файлы, присутствующие в назначении, но **старее** источника → обновляются.
3. Файлы, присутствующие в назначении и **новее** источника → пропускаются.
4. Файлы, одинаковые по времени → пропускаются.


#### Альтернативный вариант: сравнение по контрольным суммам (`--checksum`)


```bash
rsync -av --checksum /источник/ /назначение/
```

Как работает:

- Сравнивает файлы **по содержимому** (вычисляет контрольные суммы), а не по времени.  
- Гарантирует копирование, если файл хоть немного изменился.
- Плюсы: надёжнее (не зависит от корректности временных меток). 
- Минусы: медленнее (требуется расчёт сумм для всех файлов).


#### Дополнительные полезные опции

`--dry-run` (`-n`) — тестовый прогон (показывает, что будет сделано):  
  ```bash
  rsync -avun /источник/ /назначение/
  ```
  
`--progress` — показывает прогресс копирования:  
  ```bash
  rsync -avu --progress /источник/ /назначение/
  ```
  
`--exclude` — исключение файлов/папок:  
  ```bash
  rsync -avu --exclude='*.tmp' --exclude='cache/' /источник/ /назначение/
  ```
  
`-z` — сжатие данных (для сетевых операций): 
  ```bash
  rsync -avuz /источник/ пользователь@сервер:/назначение/
  ```
  
`--log-file` — запись лога:  
  ```bash
  rsync -avu --log-file=/var/log/rsync.log /источник/ /назначение/
  ```

#### Примеры сценариев

1. Локальное копирование (новые + обновлённые файлы):

```bash
rsync -avu /home/user/docs/ /backup/docs/
```

2. Сетевое копирование с сжатием и логом:

```bash
rsync -avuz --log-file=/var/log/rsync_backup.log \
  /home/user/photos/ user@backup-server:/photos/
```

3. Исключить временные файлы и кэши:

```bash
rsync -avu \
  --exclude='*.tmp' \
  --exclude='cache/' \
  --exclude='logs/' \
  /var/www/html/ /backup/website/
```

4. Тестовый прогон перед реальным копированием:

```bash
rsync -avun /источник/ /назначение/
# Если вывод устраивает — убрать `-n` и запустить реально
```

#### Важное

1. Слэш в конце пути:

- `/источник/` — копирует содержимое директории.  
- `/источник` — копирует саму директорию (вместе с именем).


2. Права доступа:

- Убедитесь, что у вас есть права на чтение источника и запись в назначение.


3. Временные метки:

- Опция `-u` полагается на корректность времени модификации файлов.  
- Если время сбито (например, из‑за разных часовых поясов), используйте `--checksum`.

4. Удаление файлов:

- По умолчанию `rsync` **не удаляет** файлы из назначения. 
- Если нужно «зеркальное» копирование, добавьте `--delete` (осторожно!)


5. Жёсткие ссылки и символические ссылки:

- `-a` сохраняет символические ссылки как есть. 
- Для копирования содержимого ссылок используйте `-L`
