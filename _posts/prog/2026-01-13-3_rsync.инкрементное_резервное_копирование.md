---
layout: post
title: rsync. Инкрементное резервное копирование
categories: Программы
---

Инкрементное копирование означает, что после **первого полного бэкапа** последующие запуски копируют **только изменённые или новые файлы**, существенно экономя время и место.

#### Базовый принцип работы

1. Первый запуск - копируются все файлы (полный бэкап)

2. Последующие запуски - `rsync` сравнивает файлы по:

- времени модификации
- контрольным суммам (при опции `--checksum`)
- размеру
   
3. Копируются только файлы, которые:

- были изменены
- добавлены
- отсутствуют в бэкапе

#### 1. Простой инкрементный бэкап (без жёстких ссылок)

```bash
rsync -av --delete /источник/ /бэкап/
```

- `-a` - архивный режим (сохраняет права, временные метки, ссылки).  
- `-v` - подробный вывод. 
- `--delete` - удаляет из бэкапа файлы, которых уже нет в источнике (создаёт «зеркало»).

> **Важно:** Без `--delete` удалённые в источнике файлы останутся в бэкапе.


#### 2. Инкремент с жёсткими ссылками (экономия места)

Для хранения нескольких версий бэкапа без дублирования неизменных файлов:


```bash
rsync -a --link-dest=/бэкап/последняя_версия/ /источник/ /бэкап/новая_версия/
```

- `--link-dest` - указывает на предыдущий бэкап.
- Неизменные файлы не копируются, а создаются как жёсткие ссылки (занимают 0 дополнительного места).
- Изменённые/новые файлы копируются полностью.

Пример сценария:

```bash
#!/bin/bash
SOURCE="/home/user/docs/"
BACKUP="/backup/docs/"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
LAST_BACKUP=$(ls -1t $BACKUP | head -1)

rsync -a --link-dest="$BACKUP/$LAST_BACKUP/" "$SOURCE" "$BACKUP/$TIMESTAMP/"
```

#### Полезные опции

- `--checksum` - сравнивает файлы по контрольным суммам (надёжнее, но медленнее). 
- `-z` - сжимает данные при передаче (полезно для сетевых бэкапов). 
- `--exclude` - исключает файлы/папки: 
  ```bash
  rsync -av --exclude='*.tmp' --exclude='cache/' /источник/ /бэкап/
  ```
  
- `--dry-run` - тестовый прогон (показывает, что будет сделано, без изменений): 

  ```bash
  rsync -avn --delete /источник/ /бэкап/
  ```
  
- `--log-file=файл` - запись лога: 
  ```bash
  rsync -av --delete --log-file=/var/log/rsync.log /источник/ /бэкап/
  ```

#### Автоматизация через `cron`

Чтобы запускать бэкап ежедневно в 2:00:

1. Откройте редактор `cron`: 

   ```bash
   crontab -e
   ```
2. Добавьте строку: 

   ```bash
   0 2 * * * rsync -av --delete /источник/ /бэкап/
   ```

#### Рекомендации

1. Всегда тестируйте с `--dry-run` перед реальным запуском. 
2. Проверяйте права доступа - у пользователя должны быть права на чтение источника и запись в бэкап. 
3. Храните несколько версий - используйте `--link-dest` для экономии места. 
4. Для сетевых бэкапов используйте SSH: 

   ```bash
   rsync -avz -e ssh user@сервер:/источник/ /локальный_бэкап/
   ```
   
5. Контролируйте свободное место - инкрементные бэкапы могут расти, если много изменений.


#### Пример полного сценария бэкапа

```bash
#!/bin/bash
SOURCE="/var/www/html/"
BACKUP="/backup/website/"
DATE=$(date +"%Y-%m-%d")
LOG="/var/log/rsync_$DATE.log"


rsync -av --delete \
  --exclude='tmp/' \
  --exclude='*.log' \
  --log-file="$LOG" \
  "$SOURCE" "$BACKUP$DATE/"
```

Этот скрипт: 

- копирует сайт, 
- исключает временные файлы и логи, 
- сохраняет лог с датой.
