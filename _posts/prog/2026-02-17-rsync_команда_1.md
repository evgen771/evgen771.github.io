---
layout: post
title: rsync. Копирование только новые и изменённые файлы.
categories: Программы
---

Чтобы `rsync` копировал **только новые и изменённые файлы** (пропуская уже существующие и неизменные), используйте комбинацию опций, ориентированных на сравнение времени модификации и размера файлов.

## Основные принципы работы

По умолчанию `rsync` уже **не копирует идентичные файлы** — он сравнивает:
- время последней модификации (`mtime`);
- размер файла;
- (опционально) контрольные суммы

Если файл в источнике и назначении имеет одинаковое время и размер, копирование пропускается.


## Ключевые опции

1. **`-a`** (`--archive`)  
   Включает режим архива: рекурсивное копирование, сохранение прав, владельцев, времени и др.  
   *Обычно используется как базовая опция.*

2. **`-v`** (`--verbose`)  
   Подробный вывод: показывает, какие файлы копируются.

3. **`-u`** (`--update`)  
   **Пропускает файлы, которые новее в месте назначения.**  
   *Ключевая опция для «только новые и изменённые».*


4. **`--ignore-existing`**  
   Пропускает **все** уже существующие файлы (даже если они старше).  
   *Используется, если нужно копировать строго новые файлы (без обновления старых).*

5. **`-c`** (`--checksum`)  
   Сравнивает файлы по контрольным суммам (а не только по времени и размеру).  
   *Медленнее, но точнее.*

6. **`--dry-run`** (`-n`)  
   Тестовый прогон: показывает, что будет скопировано, без реальных изменений.
   
7. - **`--progress`**: отображает прогресс копирования.   


## Практические примеры

### 1. Копирование новых и обновлённых файлов (базовый вариант)
```bash
rsync -avu --progress/ source/ /destination/
```
- `-a`: архивный режим.
- `-v`: подробный вывод.
- `-u`: пропускает файлы, которые новее в назначении.
- `--progress`: отображает прогресс копирования.


**Как работает:**  
- Если файл в источнике **новее** (по времени модификации), он копируется.  
- Если файл в источнике **старее**, он пропускается.  
- Если файла нет в назначении, он копируется (новый файл).


### 2. Копирование с проверкой контрольных сумм (точная синхронизация)
```bash
rsync -avuc /source/ /destination/
```
- `-c`: сравнивает файлы по контрольным суммам (гарантирует, что даже при одинаковом времени модификации изменённый файл будет скопирован).


**Когда использовать:**  
Если время модификации файлов могло быть изменено (например, при восстановлении из бэкапа).

### 3. Тестовый прогон (проверка без копирования)
```bash
rsync -avun /source/ /destination/
```
- `-n`: показывает, какие файлы будут скопированы, без реальных действий.

**Полезно:**  
Перед запуском реальной синхронизации, чтобы убедиться, что копируются только нужные файлы.

### 4. Копирование только новых файлов (без обновления существующих)
```bash
rsync -av --ignore-existing /source/ /destination/
```
- `--ignore-existing`: пропускает **все** файлы, которые уже есть в назначении (даже если они старше).

**Результат:**  
Копируются только файлы, отсутствующие в `/destination/`.


### 5. Синхронизация с удалением устаревших файлов
```bash
rsync -avu --delete /source/ /destination/
```
- `--delete`: удаляет файлы в `/destination/`, если их нет в `/source/`.  

**Важно:**  
Используйте осторожно — может привести к потере данных.


### 6. Копирование с исключением временных файлов
```bash
rsync -avu --exclude='*.tmp' --exclude='cache/' /source/ /destination/
```
- `--exclude`: исключает файлы/каталоги по шаблону.

**Пример:**  
Не копирует файлы `.tmp` и содержимое папки `cache/`.

## Как это работает под капотом

1. **Сравнение времени модификации**  
   `rsync` смотрит на `mtime` (время последнего изменения) файла в источнике и назначении.  
   Если источник новее — копирует.


2. **Проверка размера**  
   Если время совпадает, но размер разный — копирует.

3. **Контрольные суммы (если `-c`)**  
   Если включены, сравнивает хеш‑суммы файлов (гарантирует идентичность).


4. **Пропуск существующих (если `--ignore-existing`)**  
   Не проверяет время/размер — просто игнорирует файлы, уже присутствующие в назначении.


## Рекомендации

1. **Для регулярного бэкапа:**  
   ```bash
   rsync -avu /source/ /backup/
   ```
   *Копирует только новые и обновлённые файлы.*

2. **Для точной синхронизации (с проверкой содержимого):**  
   ```bash
   rsync -avuc /source/ /destination/
   ```

3. **Для однократного копирования новых файлов:**  
   ```bash
   rsync -av --ignore-existing /source/ /destination/
   ```

4. **Перед массовым копированием — тестируйте:**  
   ```bash
   rsync -avun /source/ /destination/
   ```

## Важные нюансы

- **Завершающий слеш в пути**  
  - `/source/` (со слешем) — копирует содержимое каталога.  
  - `/source` (без слеша) — копирует сам каталог внутрь назначения.


- **Права доступа**  
  Для сохранения владельцев и групп может потребоваться `sudo`.

- **SSH‑синхронизация**  
  Для удалённого копирования добавьте `-e ssh`:  
  ```bash
  rsync -avu -e ssh /local/ /user@remote:/remote/
  ```

- **Скорость передачи**  
  Используйте `-z` для сжатия:  
  ```bash
  rsync -avuz /source/ /destination/
  ```
